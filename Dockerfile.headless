# ä½¿ç”¨ Python 3.10.15 slim é•œåƒä½œä¸ºåŸºç¡€é•œåƒ
FROM python:3.10.15-slim-bookworm

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ requirements.txt
COPY requirements.txt .

# å®‰è£…ç³»ç»Ÿä¾èµ–å’Œ Python åŒ…
# --no-install-recommendsï¼Œè¡¨ç¤ºåªè£…ä½ æ˜ç¡®åˆ—å‡ºçš„åŒ…ï¼Œä¸ä¼šè‡ªåŠ¨æ‹‰å–æ¨èåŒ…
RUN apt-get update && apt-get install -y --no-install-recommends \
    libasound2 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libatspi2.0-0 \
    libcairo2 \
    libcups2 \
    libdbus-1-3 \
    libexpat1 \
    libgbm1 \
    libglib2.0-0 \
    libgtk-3-0 \
    libnspr4 \
    libnss3 \
    libpango-1.0-0 \
    libx11-6 \
    libxcomposite1 \
    libxdamage1 \
    libxext6 \
    libxfixes3 \
    libxkbcommon0 \
    libxrandr2 \
    libxcb1 \
    fonts-noto-color-emoji \
    fonts-noto-cjk \
    locales \
    ca-certificates \
    iproute2 \
    procps \
    cron \
    wget \
    curl \
    jq \
    unzip \
    && pip install --no-cache-dir -r requirements.txt \
    \
    # ğŸ”½ è‡ªåŠ¨è·å–æœ€æ–°ç‰ˆ Stable Chrome Headless Shell
    && echo "Fetching latest Chrome Headless Shell ..." \
    && VERSION_URL=$(curl -s https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json \
        | jq -r '.channels.Stable.downloads["chrome-headless-shell"][] | select(.platform=="linux64") | .url') \
    && echo "Downloading from: $VERSION_URL" \
    && wget -O /tmp/chrome-headless-shell.zip "$VERSION_URL" \
    && unzip /tmp/chrome-headless-shell.zip -d /opt/chrome-headless-shell \
    && ln -sf /opt/chrome-headless-shell/chrome-headless-shell-linux64/chrome-headless-shell /usr/local/bin/chrome-headless-shell \
    && rm -rf /tmp/chrome-headless-shell.zip \
    \
    # æ¸…ç†ç¼“å­˜ï¼Œå‡å°ä½“ç§¯
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®ç¯å¢ƒå˜é‡
# å¦‚æœä½ ä¸ç¡®å®šç¼ºä»€ä¹ˆä¾èµ–ï¼Œå¯ä»¥åœ¨å®¹å™¨é‡Œè¿è¡Œ
# ldd /usr/local/bin/chrome-headless-shell | grep "not found"
ENV CHROME_PATH=/usr/local/bin/chrome-headless-shell
